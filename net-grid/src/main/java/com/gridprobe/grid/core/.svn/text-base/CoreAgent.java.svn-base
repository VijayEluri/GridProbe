package com.gridprobe.grid.core;

import java.nio.ByteBuffer;
import java.util.Collections;
import java.util.HashSet;
import java.util.Set;

import com.gridprobe.grid.Agent;
import com.gridprobe.grid.Endpoint;
import com.gridprobe.grid.GridException;
import com.gridprobe.grid.Lan;
import com.gridprobe.grid.Message;
import com.gridprobe.grid.Protocol;
import com.gridprobe.grid.Report;
import com.gridprobe.grid.GridException.Failure;
import com.gridprobe.grid.serialization.Binaryzable;
import com.gridprobe.grid.serialization.BinaryzationException;
import com.gridprobe.grid.serialization.ObjectSerializer;

public class CoreAgent implements Agent, Binaryzable {

	private Id id;
	private Set<Endpoint> endpoints;
	private String nickname;
	
	public CoreAgent () {
		this((Id)null, null);
	}

	public CoreAgent (String nickname, Set<Endpoint> endpoints) {
		this.id=new Id((long)(Math.random()*1000000000));	// FIXME: please do this better!
		this.nickname=(nickname == null ? "" : nickname);
		this.endpoints = endpoints;
	}
	
	public CoreAgent(Id id, Set<Endpoint> endpoints) {
		this.id = id;
		this.endpoints = endpoints;
	}
	
	public Id id() {
		return id;
	}

	public int hashCode() {
		return id.hashCode();
	}

	public Endpoint getEndpointFor(Protocol protocol) {
		for (Endpoint endpoint : endpoints) {
			if (protocol.accepts(endpoint))
				return endpoint;
		}
		
		return null;
	}

	public boolean equals(Object o) {
		try {
			return this.id.equals(((CoreAgent)o).id);
		}
		catch (Exception any) {
			return false;
		}
	}

	@Override
	public String toString() {
		StringBuilder sb = new StringBuilder();
		sb.append(id);
		sb.append(", ");
		sb.append(nickname);
		sb.append(" - endpoints: ");
		for (Endpoint ep : endpoints) {
			sb.append(ep.toString());
			sb.append("; ");
		}
		
		return sb.toString();
	}

	@Override
	public void toBytes(ByteBuffer buffer) {
		try {
			buffer.putLong(id.toLong());
			ObjectSerializer.stringToBytes(buffer, nickname);
			
			buffer.putShort((short)endpoints.size());
			for (Endpoint ep : endpoints) {
				ObjectSerializer.toBytes(buffer, ep);
			}
		}
		catch (Exception any) {
			throw BinaryzationException.create(any);
		}
	}

	@Override
	public void fromBytes(ByteBuffer buffer) {
		try {
			id = new Id(buffer.getLong());
			nickname = ObjectSerializer.stringFromBytes(buffer);
			
			int num = buffer.getShort();
			endpoints = new HashSet<Endpoint>();
			for (int i = 0; i < num; i++) {
				endpoints.add((Endpoint)ObjectSerializer.fromBytes(buffer));
			}
		}
		catch (Exception any) {
			throw BinaryzationException.create(any);
		}
	}

	public boolean isOn(Lan lan) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public Set<Endpoint> endpoints()  {
		return Collections.unmodifiableSet(endpoints);
	}

	@Override
	public Report send(Message message) throws GridException {
		// TODO Auto-generated method stub
		throw new GridException(Failure.NET_ERROR, "Sorry, unimplemented!");
	}

	@Override
	public Report send(Message message, MessageCallback callback)
			throws GridException {
		// TODO Auto-generated method stub
		throw new GridException(Failure.NET_ERROR, "Sorry, unimplemented!");
	}

}
