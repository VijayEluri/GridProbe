package com.gridprobe.grid.serialization;

import java.nio.ByteBuffer;

// TODO how to serialize nulls?
public class ObjectSerializer {

	private static final String ENCODING = "UTF-8";

	private ObjectSerializer() {
	}

	public static void toBytes(ByteBuffer buffer, Binaryzable o) {
		try {
			stringToBytes(buffer, o.getClass().getName());
			o.toBytes(buffer);
		} catch (Exception any) {
			throw BinaryzationException.create(any);
		}
	}

	public static Binaryzable fromBytes(ByteBuffer buffer) {
		try {
			String className = stringFromBytes(buffer);
			Binaryzable o = (Binaryzable)Class.forName(className).newInstance();
			o.fromBytes(buffer);
			return o;
		} catch (Exception any) {
			throw BinaryzationException.create(any);
		}
	}

	public static String stringFromBytes(ByteBuffer buffer) {
		try {
			final int size = (int)buffer.get();
			final byte[] bytes = new byte[size];
			buffer.get(bytes);
			return new String(bytes, ENCODING);
		} catch (Exception any) {
			throw BinaryzationException.create(any);
		}
	}

	public static void stringToBytes(ByteBuffer buffer, String text){
		try {
			final byte[] bytes = text.getBytes(ENCODING);
			buffer.put((byte)bytes.length);
			buffer.put(bytes);
		} catch (Exception any) {
			throw BinaryzationException.create(any);
		}
	}

}
